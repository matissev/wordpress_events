                                                           /*._
                                                    .,c="""  _JLccccc,
     GULPFILE                                   ,r="     ,,-'         "=c
                                             ,J"    ,c$?$ $ `$c          `=,
  ,▄▄▌    ▄▄▄▄▄,                          ,c"'  ,J"" J ( j'   "$.           "c,
 ▐▓▓▀`  ▄▓▓▀▀▀▓▓▌  ?????????????""""""???"=hcJ$"    JL   `r    `$r             "$q
 ▐▓▓▄▄▓▓▓▀  ▄▄▓▓▌  `.`.`.`.`.`.`.`.`.`.`.`.`J"     j'L   `L   \  ?c               "g
   ▀▀▀▀`    ▀▀▀`   `.`.`.`.`.`.`.`.`.`.`.`.J      j'`?c   ?.   t  `$.               `=hc,;c???
 ▐▓▓               `.`.`.`.`.`.`.`.`.`.`_,$      z'.`.?L   $   `h   "=c,      ,cJ????""`.`.`.`
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌  `.`.`.`.`.`,cPP?"""'? J    ;,?.`z$$h`"$.'L3, `L  $    "" $`.`.`.`.`.`.`.`.`
 ▐▓▓               `.`.`.,c??"        ,f $   / $.`.,,,`"=`?h`?$c    `r 3r  .$`.`.`.`.`.`.`.`.`
 .▄▄▄▄▄▄▄▄▄▄▄▄▄▄   "hcr="             j  F  j  P.`$$$h3$,`.`???$c    `cc$r.P.`.`.`.`.`.`.,r`.`
 ▐▀▀▀▀▀▀▀▓▓▓▓▓▓▓▌  `.$                ( J  d$ j'.`?.$$$$`.`.,`.`="$c.,cP"" $.`.$??"??$hc$".`.`
  ▄▄▄▓▓▓█▀▀▀¬      `.`h               ( $  $$ $`.`.`.""""`.J:`hJ?$h,`.$   JF.`$"      .$.`.`.`
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌  `.`.?.             `j' ($$ $`.`.`.`.`.`f.`?$$$$$$r'3  J"`.J" \    .P`.`.`.`
  ▄,          ,▄   `.`.`?.             $  ($' $`.`.`.`.;`.`.`.`"?$??"`$ .F',$F   L  .P.`.`.`.`
 ▐▓▓    ▓▓    ╟▓▌  `.`.`.?.           j'  ($' $`.`.`.`"=cj'.`.`.`.`.`,P $'$l?F   $ j'`.`.`.`.`
 ▐▓▓▄▄▄▄▓▓▄▄▄▄▓▓▌  `.`.`.`?,          `$.  ? '$`.`.`.`.`.`.`.`.`.`.`,$  $$j'j'   $z?.`.`.`.`.`
 ▐▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀  `.`.`.`.?,         ( $    j'`.`.J$I?$c,.`.`.`.`.J$F  $cJ      3F`.`.`.`.`.`
 ▐▓▓▓▓▄▄▄▄,,       `.`.`.`.``h          j'   $h`.`.?6$cI$9;`.`.`.c$$" .$" L    .P".`.`.`.`.`.`
   ¬`"▀▀▀▀▀▀█▓▓▓▌  `.`.`.`.`.`?.        $   J$?,.`.`.??i???`.`.`.`$F.P$$  ?   J?.`.`.`.`.`.`,P
  ▄▄▄▄▓▓▓▓▓▓▓▓▓▓▌  `.`.`.`.`.`."h.      $  J$$.?.`.`.`.`.`.`.`.`,$$,c'`$   L,P.`.`.`.`.`.`.,F
 ▐█▀▀▀▀▀Γ¬         h.`.`.`.`.`.`.?h    J  J3$$.`3`.`.`.`.`.`.`.J$$"$   $   J"`.`.`.`.`.`.`,P
 ▐▓▓    ▄▄    ╟▓▌  `h`.`.`.`.`.`.`.?h .F J'<$F.`.?h_.`.`.`.,c$$$$$ $  ,P J?`.`.`.`.`.`.`.,P
 ▐▓▓    ▓▓    ╟▓▌    $.`.`.`.`.`.`.`.?$ J' <$`.`.`.`?=hc=?"'J$$$$" $  $.P`.`.`.`.`.`.`.`,P
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌     $`.`.`.`.`.`.`.`f $  <$`.`.`.`.`.`.`.;$$$$   F  $?.`.`.`.`.`.`.`.,F
                       ?.`.`.`.`.`.`.(f $. j'`.`.`.`.`.`.`.$$$P   JF JF`.`.`.`.`.`.`.`,F
                        ",.`.`.`.`.`.`$'F  J)`.`.`.`.`.`.`J$P    Jl$$?.`.`.`.`.`.`.`.,F;
  ▄▓▓▌   ,▄▓▓▓▓▄         "i`.`.`.`.`.`? $ ($.`.`.`.`.`.`.z$"    J$"J"`.`.`.`.`.`.`.`,P }     j
 ▐▓▓`  ,▓▓▓▀Γ^▓▓▌         ?`.`.`.`.`.`.?`  P.`h`.,c`.`.`J" ,' z$"'J".`.`.`.`.`.`.`.,P j      f
 "▓▓▓▓▓▓▓▀  ▓▓▓▓▀          ?.`.`.`.`.`.`h  F.`$'z?.`.`,",$" zP"`.`?`.`.`.`.`.`.`.`,P ,      j'
   ¬▀▀Γ     ▀▀└             ?`.`.`.`.`.`.??'.<$$.`.`.J$"j'c$.`.`.`.`.`.`.`.`.`.`.j'  $     j .
  ▓▓▓▌   ▄▓▓▓▓▓▓µ            $.`.`.`.`.`.`.`.$?`.`.`.`.,$?.`.`.`.`.`.`.`.`.`.`.`JF  .F    J"L
 ▐▓▓  ,▄▓▓▀   ▐▓▌             $`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.J$   $   .P   k
  ▀▓▓▓▓█▀   ▓▓▓▀              `h,c.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,$$$   `h  P
 ╒▄▄          ╓▄e             ,P"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,$"$$    $ $
 ▐▓▓    ▓▓    ╟▓▌           ,P.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.;$F $$r    ?c,  _c"
 ▐▓▓▄▄▄▄▓▓▄▄▄▄▓▓▌         ,P"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`;$'F  $$       ""
 `▀▀▀▀▀▀▀▀▀▀▀▀▀▀"       .$"`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,P  $  `$$
  ▄▓▓▓▓▓▄▄▓▓▓▓▓▓▌      J?`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,$   $     "=,_
 ▐▓▓└,,^▓▓▓`¬¬¬¬     ,P`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`$$   ?         "=cccc"
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌  ,$"h`.`.`.`.`.`.`.`.`.`.,cc,`.`.`.`.`.`.`.`.`.`.`.`.JP$.  `t     -c   3,
  ▀▀▀▀▀▀▀▀▀▀▀▀▀▀└  $`.3`.`.`.`.`.`.`.;.`.`$,c,3`.`.`.`.`.`.;;`.`.`.`.`;$ `L   $       3.  ?.
  ▓▓▓▓▓▓▓▓▄        $$iJ`.`.`.`.`.`.`;;.`.`$?;t$).`.`.`.`.`;;;`.`.`.`.,$'  $   `L       $   $
 ▐▓▓    j▓▓        ?$F;`.`.`.`.`.`.`;;.`.``$iP"`.`.`.`.`.`;;:`.`.`.`.$$   $    3.      $   3
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌  `h;;,.`.`.`.`.`.`?;;`.`.`.`.`.`.`.`.`.;;3.`.`.`.`,$$  j'L    $     J"   $
   ,▄▄▄▄▄▄▄▄▄▄,     ?;;;;,.`.`.`;;.`$;;;.`.`.`.`.`.`.`.`;;;P.`.`.`.`$$F  j ?.    `"??"    v'
  ▓▓██████████▓▓µ   `h;;;;;;,;;;;).`?h;;,`.`.`.`.`.`.`;;;;$`.`.`.`.f'$F  J  ?,         .$"
 ▐▓▓          ╟▓▌     ?c;;;;;;;;F`.`.$h;;;,`.`.`.`.,;;;;;$'`.`.`.`f  $)  $   `"?????c=" 4r
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌      ?c;;;;;;F.`.`.`?y;;;;;;;,;;;;;;;iP`.`.`.`.J'  $   $              j'
   ,╓▄▄,   ,▄▄▄▄⌐       `"?jj$F;.`.`.`.`$y;;;;;;;;;;;jP".`.`.`.`;$   $   F              j'
  ▓▓▓██▓▓▓▓█████▀            3;;.`.`.`.`.`?hijjjjid$?".`.`.`.`.,f    $   F              j'
 ▐▓▓    ▓▓▌                   h;.`.`.`.`.`.`.`.`.`.`.`.`.`.`.`,;$'  ;F   L              P
 ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌             ?h.`.`.`.`.`.`.`.`.`.`.`.`.`.`.,;;$   $    ? ,cc         $
   ,▄▄▄▄▄▄▄▄▄▄▄               `$;`.`.`.`.`.`.`.`.`.`.`.`.`.`,;;;$   $     "   ?.     z"
 ]▓▓▀▀▀▀▀▀▀▀▀▀▓▓▄              ?;`.`.`.`.`.`.`.`.`.`.`.`.`.;;;;;$   `r         h.,zJ"
 ▐▓▓,,,,,,,,,,▓▓▌               h;.`.`.`.`.`.`.`.`.`.`.`.`;;;;;;$    ?        `$
  ▀▀██████████▀▀                `h;;;,.`.`.`.`.`.`.`.`.`.`;;;;;;$     $       .F
 ▐▓▓▄▄▄▄▄▄,,                     $;;;;;;.`.`.`.`.`.`.`.`.,;;;;;;$      "hcc$  $
  ¬^`▀▀▀▀▀▀▀▓▓▓▓▌                `h;;;;;,`.`.`.`.`.`.`.`.;;;;;;;$.           j'
 ▐▓▓▓▓▓▓▓▓▀▀▀▀▀▀^                 ?;;;;;;;.`.`.`.`.`.`.`.;;;;;;;9L,         J'
  ▀▀▀▀▀▀▀▀▀▀▓▓▓▓▌                  ?;;;;;;;`.`.`.`.`.`.`.;;;;;;;;h "cc,__,c"
 ]▓▓▓▓▓▓▓▓▓▓▓▓█▀▀                   $;';;;;,.`.`.`.`.`.`.;;;;;;';9r
  ▀▀Γ¬¬                              $;`.`.`.`.`.`.`.`.`.;;`.`;`.`?*/                       



/* ------------------------------------------
-------------------------- WARNINGS ----- /!\

- To support the developement mode, please add php as an extension in gulp-remove-code/index.js (function applyReplacements)

-------------------------- WARNINGS ----- /!\
------------------------------------------ */



/* ------------ INIT ------------ */

var gulp = require('gulp'),
	fs = require('fs'),
	del = require('del'),

	browserSync = require('browser-sync'),
	connect = require('gulp-connect-php'),

	watch = require('gulp-watch'),
	sequence = require('run-sequence'),
	plumber = require('gulp-plumber'),
	notify = require('gulp-notify'),
	filter = require('gulp-filter'),
	run = require('gulp-run'),

	less = require('gulp-less'),
	cleancss = require('gulp-clean-css'),
	prefixer = require('gulp-autoprefixer'),
	sourcemaps = require('gulp-sourcemaps'),
	removeCode = require('gulp-remove-code'),

	concat = require('gulp-concat'),
	uglify = require('gulp-uglify'),

	imagemin = require('gulp-imagemin'),
	spritesheet = require('gulp-svg-sprite'),
	svg2png = require('gulp-svg2png');


var paths = {
	src : {
		templates : ['./www/**/*.php', '!./www/assets', '!./www/assets/**/*'],
		style : './www/assets/style', /* No file type is specified because of the spritesheet */
		js : './www/assets/js', /* No file type is specified because of _compile.json */
		img : ['./www/assets/img/**/*', '!./www/assets/img/sprite', '!./www/assets/img/sprite/**/*'],
		sprite : './www/assets/img/sprite/**/*.svg',
		fonts : './www/assets/fonts/**/*'
	},
	dist : {
		templates : './wordpress/wp-content/themes/custom',
		style : './wordpress/wp-content/themes/custom',
		js : './wordpress/wp-content/themes/custom/assets/js',
		img : './wordpress/wp-content/themes/custom/assets/img',
		fonts : './wordpress/wp-content/themes/custom/assets/fonts'
	}
}


/* ------------ UTILITY ------------ */

gulp.task('clean', function (callback) {
	return del(paths.dist.templates + '/**/*', callback);
});

var onError = function(err) {
	notify.onError({
		title: 'Compilation error',
		message: '<%= error.message %>',
		sound: 'Tink'
	})(err);
	
	this.emit('end');
};

gulp.task('serve', function() {
	// Wordpress Server
	connect.server({
		base: 'wordpress'
	}, function (){
		browserSync({
			proxy: {
				target: '127.0.0.1:8000',
				ws: true,
			},
			snippetOptions : {
				blacklist : '**/*.*',
			},
			open: 'wordpress'
		});
	});

	// phpMyAdmin Server
	connect.server({
		base: './phpmyadmin',
		open: false,
		hostname: '127.0.0.1',
		port: '1337'
	});
});


/* ------------ BUILDING FUNCTIONS ------------ */

gulp.task('templates', function(){
	return gulp.src(paths.src.templates)
		.pipe(gulp.dest(paths.dist.templates))
		.pipe(browserSync.stream({once: true}));
});

gulp.task('templates-dist', function(){
	return gulp.src(paths.src.templates)
		.pipe(removeCode({ production: true }))
		.pipe(gulp.dest(paths.dist.templates))
		.pipe(browserSync.stream({once: true}));
});

gulp.task('less', function(){
	return gulp.src(paths.src.style + '/*.less')
		.pipe(plumber({errorHandler: onError}))
		.pipe(sourcemaps.init())
		.pipe(less())
		.pipe(prefixer('last 5 versions', 'ie 9'))
		.pipe(cleancss({compatibility: 'ie9'}))
		.pipe(sourcemaps.write())
		.pipe(gulp.dest(paths.dist.style))
		.pipe(browserSync.stream({match: "**/*.css"}));
});

gulp.task('less-dist', function(){
	return gulp.src(paths.src.style + '/*.less')
		.pipe(less())
		.pipe(removeCode({ production: true }))
		.pipe(prefixer('last 5 versions', 'ie 9'))
		.pipe(cleancss({compatibility: 'ie9'}))
		.pipe(gulp.dest(paths.dist.style));
});

gulp.task('js', function(){
	var scripts = JSON.parse(fs.readFileSync(paths.src.js + '/_compile.json', { encoding: 'utf8' }));

	return scripts.forEach(function(obj){
		return gulp.src(paths.src.js + '/' + obj.src)
			.pipe(plumber({errorHandler: onError}))
			.pipe(sourcemaps.init())
			.pipe(concat(obj.name))
			.pipe(uglify())
			.pipe(sourcemaps.write())
			.pipe(gulp.dest(paths.dist.js))
		.pipe(browserSync.stream({once: true}));
	});
});

gulp.task('js-dist', function(){
	var scripts = JSON.parse(fs.readFileSync(paths.src.js + '/_compile.json', { encoding: 'utf8' }));

	return scripts.forEach(function(obj){
		return gulp.src(paths.src.js + '/' + obj.src)
			.pipe(concat(obj.name))
			.pipe(uglify())
			.pipe(gulp.dest(paths.dist.js));
	});
});

gulp.task('fonts', function(){
	return gulp.src(paths.src.fonts)
		.pipe(gulp.dest(paths.dist.fonts));
});

gulp.task('img', function(){
	return gulp.src(paths.src.img)
		.pipe(imagemin({
			multipass: true,
			interlaced: true,
			optimizationLevel: 9,
			svgoPlugins: [
				{ removeViewBox: true },
				{ removeUselessStrokeAndFill: true },
				{ removeEmptyAttrs: true }
			]
		}))
		.pipe(gulp.dest(paths.dist.img));
});

gulp.task('spritesheet', function() {
	return gulp.src(paths.src.sprite, {cwd: '.'})
		.pipe(spritesheet({
			'svg': {
				'xmlDeclaration': false,
				'doctypeDeclaration': false,
				'namespaceIDs': false,
				'dimensionAttributes': false
			},
			'shape': {
				'id': {
					'whitespace': '_'
				}
			},
			'mode': {
				'css': {
					'dest': paths.src.style,
					'prefix': '.icon-%s',
					'dimensions': true,
					'sprite': '../img/sprite.svg',
					'bust': false,
					'render': {
						'less': {
							'dest': './utilities/sprite'
						}
					}
				}
			}
		})).on('error', function(error){ console.log(error); })
		.pipe(gulp.dest('.'))
		.pipe(filter('**/*.svg'))
		.pipe(svg2png())
		.pipe(gulp.dest('.'));
});


/* ------------ MAIN ------------ */

gulp.task('images', function() {
	return gulp.src('.')
		.pipe(run('imageOptim -j -a -q -d www/assets/img/'));
});

gulp.task('done', function() {
	return gulp.src('.')
		.pipe(run('open -a iterm'))
		.pipe(notify({
			title: 'Compilation completed',
			message: 'Your distribution folder is now ready',
			sound: 'Tink'
		}));
});

gulp.task('make', ['clean'], function(callback) {
	sequence(
		'spritesheet',
		['less', 'img', 'fonts', 'templates', 'js'],
		'serve',
	callback);
});

gulp.task('default', ['make'], function() {
	gulp.watch(paths.src.templates, ['templates']);

	gulp.watch(paths.src.style + '/**/*.less', ['less']);

	gulp.watch([paths.src.js + '**/*.js', paths.src.js + '/_compile.json'], ['js']);
});

gulp.task('dist', ['clean'], function(callback) {
	sequence(
		'spritesheet',
		['less-dist', 'img', 'fonts', 'templates-dist', 'js-dist'],
		'done',
	callback);
});